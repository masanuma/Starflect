# Starflect - アプリ仕様書（実装準拠版）

## 📋 システム概要

### アプリケーション情報
- **名称**: Starflect（スターフレクト）
- **種類**: Progressive Web App (PWA)
- **分野**: 西洋占星術AI分析アプリ
- **本番URL**: starflect-production.up.railway.app
- **バージョン管理**: v2.0.0（ローカルDBバージョニング）

### 基本仕様
- **フロントエンド**: React 18 + TypeScript + Vite
- **計算エンジン**: 独自開発天体計算システム
- **AI連携**: OpenAI GPT-4/3.5-turbo
- **データ保存**: LocalStorage（クライアントサイド）
- **デプロイ**: Railway（自動デプロイ）

## 🎯 機能仕様

### 1. モード選択システム
ユーザーは3つのレベルから選択可能：

#### Level 1: お手軽12星座占い（🌟）
- **必要情報**: 生年月日のみ
- **処理時間**: 約30秒
- **分析内容**: 太陽星座による基本性格・運勢
- **出力**: 簡潔な占い結果

#### Level 2: 詳しい隠れた自分診断（🌙）
- **必要情報**: 生年月日 + 出生時刻 + 出生場所
- **処理時間**: 約1分
- **分析内容**: 太陽・月・上昇星座の3天体分析
- **出力**: 内面性格、隠れた特徴、外面印象

#### Level 3: プロ級あなたの印象診断（🌌）
- **必要情報**: 生年月日 + 出生時刻 + 出生場所
- **処理時間**: 約2分
- **分析内容**: 10天体完全分析 + アスペクト
- **出力**: 詳細な性格分析、天体個別解説、アスペクト関係

### 2. 入力システム

#### 入力フォーム機能
- **名前入力**: テキストフィールド（任意）
- **生年月日**: 年月日選択（WheelPicker対応）
- **出生時刻**: 時分選択（不明時は正午デフォルト）
- **出生場所**: Google Maps API連携検索

#### バリデーション機能
- **必須項目チェック**: レベルに応じた必要情報確認
- **日付妥当性**: 1900年〜現在日まで対応
- **時刻形式**: 24時間形式（HH:MM）
- **場所確認**: 緯度経度座標取得確認

#### データ管理機能
- **自動保存**: 入力中の自動保存機能
- **復元機能**: 過去の入力データ復元
- **クリア機能**: 選択的データ削除（基本情報保持/全削除）
- **バージョニング**: v2.0.0自動アップグレード

### 3. 天体計算エンジン

#### 対応天体（10天体）
1. **太陽**: 基本性格・意識・目標
2. **月**: 感情・本音・プライベート
3. **水星**: コミュニケーション・知性
4. **金星**: 愛情・美的センス・価値観
5. **火星**: 行動力・怒り・情熱
6. **木星**: 成長・発展・幸運
7. **土星**: 責任・制限・試練
8. **天王星**: 変革・独創性・突発性
9. **海王星**: 直感・芸術性・スピリチュアル
10. **冥王星**: 変容・深層心理・極限状況

#### 計算精度
- **時刻精度**: 分単位対応
- **位置精度**: 度数小数点以下1桁
- **逆行判定**: 1日後位置比較による正確判定
- **ハウス計算**: 等分ハウスシステム
- **アスペクト**: 6種類（合・衝・三分・四分・六分・150度）

#### 計算アルゴリズム
- **ユリウス日変換**: 天文学的基準日計算
- **太陽**: 平均黄経 + 中心差計算
- **月**: 平均黄経 + 主要項中心差
- **惑星**: ケプラー方程式による軌道計算

### 4. AI分析システム

#### OpenAI連携仕様
- **API**: OpenAI GPT-4/3.5-turbo
- **タイムアウト**: Level1/2=30秒、Level3=60秒
- **リトライ**: 最大3回、指数バックオフ
- **レスポンス**: JSON形式、型安全解析

#### 分析機能
1. **性格分析**: 深層心理〜表面特徴
2. **運勢分析**: 総合・恋愛・仕事・健康・金運
3. **天体個別分析**: 各天体の特徴・影響・アドバイス
4. **アスペクト分析**: 天体関係性（調和・緊張）
5. **未来予測**: 1週間・1ヶ月・3ヶ月・1年

#### AI占い師チャット
- **カテゴリ**: 恋愛・仕事・人間関係・将来・性格・その他
- **履歴保存**: LocalStorageによる永続化
- **コンテキスト**: 占い結果を踏まえた回答

### 5. 表示システム

#### 結果表示機能
- **段階的表示**: ステップバイステップ結果表示
- **天体配置表**: 星座×天体のマトリックス表示
- **アスペクト表**: 天体関係性の色分け表示
- **天体関係性解説**: 重要なアスペクトの詳細説明

#### UI/UX仕様
- **デザイン**: ガラスモルフィズム
- **レスポンシブ**: モバイルファースト設計
- **アニメーション**: CSS3トランジション
- **アクセシビリティ**: WCAG 2.1 AA準拠

### 6. PWA機能

#### PWA対応機能
- **マニフェスト**: アプリライクな体験
- **Service Worker**: オフライン対応
- **アイコン**: 192px, 512px対応
- **インストール**: ホーム画面追加可能

#### オフライン機能
- **静的リソース**: 全ファイルキャッシュ
- **計算機能**: 完全オフライン動作
- **データ保存**: LocalStorage永続化

## 🔧 技術仕様

### フロントエンド技術スタック
```typescript
{
  "react": "^18.2.0",
  "typescript": "^5.0.0", 
  "vite": "^4.4.0",
  "react-router-dom": "^6.15.0"
}
```

### 開発・ビルド環境
- **開発サーバー**: Vite Dev Server（ポート5173）
- **本番ビルド**: Vite Production Build
- **型チェック**: TypeScript Strict Mode
- **テスト**: Jest + React Testing Library

### デプロイ・運用
- **本番環境**: Railway自動デプロイ
- **ドメイン**: starflect-production.up.railway.app
- **SSL**: 自動HTTPS対応
- **モニタリング**: Railway標準監視

## 📊 データ仕様

### LocalStorageデータ構造
```typescript
// バージョン管理
starflect_data_version: '2.0.0'

// 基本情報（永続保存）
birthData: {
  name: string,
  birthDate: string,
  birthTime: string,
  birthPlace: {
    name: string,
    lat: number,
    lng: number
  }
}

// 分析結果（レベル別）
level1_fortune_*: Level1Result
level2_*: Level2Result  
level3_*: Level3Result

// システム設定
starflect_tutorial_completed: boolean
```

### API仕様

#### Google Maps API
- **用途**: 出生地検索・座標取得
- **エンドポイント**: Places API, Geocoding API
- **認証**: APIキー（環境変数管理）

#### OpenAI API
- **モデル**: gpt-4, gpt-3.5-turbo
- **最大トークン**: 2000〜2500
- **温度**: 0.7（創造性とのバランス）
- **システムプロンプト**: 占星術師ペルソナ

## 🛡️ セキュリティ仕様

### プライバシー保護
- **ローカル計算**: 個人情報サーバー送信なし
- **データ保存**: LocalStorageのみ
- **第三者送信**: OpenAI APIのみ（占い分析用）

### APIキー管理
- **環境変数**: .env.localで管理
- **本番環境**: Railway環境変数
- **除外設定**: .gitignoreで保護

### XSS対策
- **React**: 自動エスケープ機能
- **入力検証**: サニタイゼーション実装
- **CSP**: Content Security Policy設定

## 📱 対応環境

### ブラウザサポート
- **Chrome**: 90+ ✅
- **Firefox**: 88+ ✅  
- **Safari**: 14+ ✅
- **Edge**: 90+ ✅
- **Mobile Safari**: iOS 14+ ✅
- **Chrome Mobile**: Android 9+ ✅

### デバイス対応
- **スマートフォン**: 375px〜 完全対応
- **タブレット**: 768px〜 最適化
- **デスクトップ**: 1024px〜 フル機能
- **高解像度**: 4K対応

## 🔄 パフォーマンス仕様

### 処理時間目標
- **Level1分析**: 30秒以内
- **Level2分析**: 60秒以内  
- **Level3分析**: 120秒以内
- **チャート描画**: 1秒以内

### ファイルサイズ
- **JavaScriptバンドル**: 500KB以下
- **CSSファイル**: 100KB以下
- **画像リソース**: 最適化済み
- **総ダウンロード**: 1MB以下

## 🧪 テスト仕様

### 単体テスト
- **天体計算**: 数学的精度検証
- **AI分析**: API レスポンス検証
- **コンポーネント**: UI動作検証

### 統合テスト  
- **データフロー**: 入力〜表示の統合
- **API連携**: 外部サービス連携
- **エラーハンドリング**: 例外処理

## 🚀 運用仕様

### 監視・メンテナンス
- **稼働監視**: Railway標準監視
- **エラーログ**: コンソール出力
- **パフォーマンス**: Lighthouse継続測定

### バックアップ・復旧
- **コード**: GitHub バージョン管理
- **設定**: Railway環境変数
- **ユーザーデータ**: LocalStorage（ユーザー管理）

## 📈 拡張仕様

### 今後の機能拡張
1. **相性診断**: 2人の関係性分析
2. **トランジット**: 未来の天体運行
3. **プログレス**: 進行図分析
4. **多言語**: 英語・中国語対応

### アーキテクチャ拡張
- **バックエンドAPI**: ユーザー管理・課金
- **データベース**: PostgreSQL/MongoDB
- **認証**: OAuth 2.0対応
- **決済**: Stripe連携

---

**最終更新**: 2025年1月22日  
**バージョン**: 2.0.0  
**実装準拠**: 本番環境と100%一致 